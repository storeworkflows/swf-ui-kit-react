"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getPopoverStyle = void 0;

var _constants = require("./constants");

var ALIGNMENT = _constants.POPOVER.ALIGNMENT,
    ARROW_SIZE = _constants.POPOVER.ARROW_SIZE,
    ARROW_ALIGN = _constants.POPOVER.ARROW_ALIGN,
    NO_ARROW_POSITIONS = _constants.POPOVER.NO_ARROW_POSITIONS,
    ARROW_SIDES = _constants.POPOVER.ARROW_SIDES,
    ARROW_SPACE = _constants.POPOVER.ARROW_SPACE;
var verticalAlignment = [ALIGNMENT.TOP, ALIGNMENT.CENTER, ALIGNMENT.BOTTOM];
var horizontalAlignment = [ALIGNMENT.START, ALIGNMENT.CENTER, ALIGNMENT.END];

var setArrowColor = function setArrowColor(align) {
  return "--arrow-".concat(align, "-color");
};

var setMargin = function setMargin(align) {
  return "margin-".concat(align);
};

var setArrowSize = function setArrowSize(align) {
  return "--arrow-".concat(align, "-size");
};

var hasArrowByPosition = function hasArrowByPosition(position, roundBorder) {
  return !(isOneOfNoArrow(position) || roundBorder && !isCenterArrow(position));
};

var isOneOfNoArrow = function isOneOfNoArrow(position) {
  var targetPosition = position.target.split('-');
  var contentPosition = position.content.split('-');
  var result = false;
  NO_ARROW_POSITIONS.forEach(function (_ref) {
    var content = _ref.content,
        target = _ref.target;
    var elTargetPosition = target.split('-');
    var elContentPosition = content.split('-');
    var isSameTargetParams = targetPosition[0] === elTargetPosition[0] && targetPosition[1] === elTargetPosition[1];
    var isSameContentParams = contentPosition[0] === elContentPosition[0] && contentPosition[1] === elContentPosition[1];
    if (isSameTargetParams && isSameContentParams) result = true;
  });
  return result;
};

var isCenterArrow = function isCenterArrow(position) {
  var contentPosition = position.content.split('-');
  return contentPosition[0] === ALIGNMENT.CENTER || contentPosition[1] === ALIGNMENT.CENTER;
};

var calculatePosition = function calculatePosition(alignType, arrayType, startPosition) {
  var addPx = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : 0;
  var result = "".concat(addPx, "px");
  if (alignType === arrayType[1]) result = "".concat(Math.round(startPosition / 2) + addPx, "px");else if (alignType === arrayType[2]) result = "".concat(startPosition + addPx, "px");
  return result;
};

var getArrowAlignment = function getArrowAlignment(arrayType, align, parentSize, size) {
  if (align === arrayType[1]) return Math.round(parentSize / 2) - size;else if (align === arrayType[2]) return parentSize - size * 2;else return 0;
};

var getArrowStyles = function getArrowStyles(position, contentDimensions) {
  var style = {};
  var targetPosition = position.target.split('-');
  var contentPosition = position.content.split('-');
  var margin = "".concat(ARROW_SIZE + ARROW_SPACE, "px");
  var isDown = targetPosition[0] === ALIGNMENT.TOP && contentPosition[0] === ALIGNMENT.BOTTOM;
  var isLeft = targetPosition[1] === ALIGNMENT.END && contentPosition[1] === ALIGNMENT.START;
  var isRight = targetPosition[1] === ALIGNMENT.START && contentPosition[1] === ALIGNMENT.END;
  var isUp = targetPosition[0] === ALIGNMENT.BOTTOM && contentPosition[0] === ALIGNMENT.TOP;
  var hasArrow = true;
  var sideToZero = null;
  var colorSide = null;
  var top = 0;
  var left = 0;

  switch (true) {
    case isDown:
      sideToZero = ARROW_SIDES.BOTTOM;
      colorSide = ARROW_SIDES.TOP;
      top = contentDimensions.height;
      left = getArrowAlignment(horizontalAlignment, contentPosition[1], contentDimensions.width, ARROW_SIZE);
      break;

    case isRight:
      sideToZero = ARROW_SIDES.RIGHT;
      colorSide = ARROW_SIDES.LEFT;
      top = getArrowAlignment(verticalAlignment, contentPosition[0], contentDimensions.height, ARROW_SIZE);
      left = contentDimensions.width;
      break;

    case isLeft:
      sideToZero = ARROW_SIDES.LEFT;
      colorSide = ARROW_SIDES.RIGHT;
      top = getArrowAlignment(verticalAlignment, contentPosition[0], contentDimensions.height, ARROW_SIZE);
      left = -ARROW_SIZE;
      break;

    case isUp:
      sideToZero = ARROW_SIDES.TOP;
      colorSide = ARROW_SIDES.BOTTOM;
      top = -ARROW_SIZE;
      left = getArrowAlignment(horizontalAlignment, contentPosition[1], contentDimensions.width, ARROW_SIZE);
      break;

    default:
      hasArrow = false;
      break;
  }

  if (hasArrow) {
    style[ARROW_ALIGN.TOP] = "".concat(top, "px");
    style[ARROW_ALIGN.LEFT] = "".concat(left, "px");
    style[setArrowColor(colorSide)] = 'var(--popover-background)';
    style[setArrowSize(sideToZero)] = 0;
    style[setMargin(sideToZero)] = margin;
  }

  return {
    hasArrow: hasArrow,
    style: style
  };
};

var getStyleByPosition = function getStyleByPosition(position, targetDimensions, contentDimensions, windowWidth, hasArrow) {
  var style = {};
  var targetPosition = position.target.split('-');
  var contentPosition = position.content.split('-');

  if (targetPosition) {
    var verticalAlign = targetPosition[0];
    var horizontalAlign = targetPosition[1];
    var targetWidth = targetDimensions.width;
    var targetHeight = targetDimensions.height;
    var addPx = 0;
    var addPxY = 0;
    var needMoveContent = verticalAlign === ALIGNMENT.TOP && contentPosition[0] === ALIGNMENT.BOTTOM;
    var needMoveContentY = horizontalAlign === ALIGNMENT.START && contentPosition[1] === ALIGNMENT.END;
    if (needMoveContent && hasArrow) addPx = -ARROW_SIZE - ARROW_SPACE;
    if (needMoveContentY && hasArrow) addPxY = -ARROW_SIZE - ARROW_SPACE;
    style.top = calculatePosition(verticalAlign, verticalAlignment, targetHeight, addPx);
    style.left = calculatePosition(horizontalAlign, horizontalAlignment, targetWidth, addPxY);
  }

  var x, y;

  if (contentPosition) {
    var _verticalAlign = contentPosition[0];
    var _horizontalAlign = contentPosition[1];
    var contentWidth = contentDimensions.width;
    var contentHeight = contentDimensions.height;
    y = calculatePosition(_verticalAlign, verticalAlignment, -contentHeight);
    x = calculatePosition(_horizontalAlign, horizontalAlignment, -contentWidth);
    style.transform = "translate3d(".concat(x, ", ").concat(y, ", 0)");
  }

  var resultX = targetDimensions.x + parseInt(style.left.replace("px", '')) + parseInt(x.replace("px", ''));
  var resultY = targetDimensions.y + parseInt(style.top.replace("px", '')) + parseInt(y.replace("px", ''));
  var isXVisible = resultX > 0 && resultX + contentDimensions.width < windowWidth;
  var isYVisible = resultY > 0;
  var isVisible = isXVisible && isYVisible;
  return {
    style: style,
    isVisible: isVisible
  };
};

var getAllStyles = function getAllStyles(position, targetDimensions, contentDimensions, windowWidth, hasArrow) {
  var arrowStyles = {
    hasArrow: false,
    style: {}
  };
  var popoverStyles = getStyleByPosition(position, targetDimensions, contentDimensions, windowWidth, hasArrow);
  if (hasArrow && popoverStyles.isVisible) arrowStyles = getArrowStyles(position, contentDimensions);
  return {
    isVisible: popoverStyles.isVisible,
    style: popoverStyles.style,
    hasArrow: arrowStyles.hasArrow,
    arrowStyle: arrowStyles.style
  };
};

var getPopoverStyle = function getPopoverStyle(positions, targetDimensions, contentDimensions, windowWidth, hideTail, roundBorder) {
  var result = {};

  for (var i = 0; i < positions.length; i++) {
    var hasArrow = !hideTail && hasArrowByPosition(positions[i], roundBorder);
    result = getAllStyles(positions[i], targetDimensions, contentDimensions, windowWidth, hasArrow);
    if (result.isVisible) break;else if (i === positions.length - 1) result = getAllStyles(positions[0], targetDimensions, contentDimensions, windowWidth, hasArrow);
  }

  return result;
};

exports.getPopoverStyle = getPopoverStyle;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Qb3BvdmVyL3V0aWxzLmpzIl0sIm5hbWVzIjpbIkFMSUdOTUVOVCIsIlBPUE9WRVIiLCJBUlJPV19TSVpFIiwiQVJST1dfQUxJR04iLCJOT19BUlJPV19QT1NJVElPTlMiLCJBUlJPV19TSURFUyIsIkFSUk9XX1NQQUNFIiwidmVydGljYWxBbGlnbm1lbnQiLCJUT1AiLCJDRU5URVIiLCJCT1RUT00iLCJob3Jpem9udGFsQWxpZ25tZW50IiwiU1RBUlQiLCJFTkQiLCJzZXRBcnJvd0NvbG9yIiwiYWxpZ24iLCJzZXRNYXJnaW4iLCJzZXRBcnJvd1NpemUiLCJoYXNBcnJvd0J5UG9zaXRpb24iLCJwb3NpdGlvbiIsInJvdW5kQm9yZGVyIiwiaXNPbmVPZk5vQXJyb3ciLCJpc0NlbnRlckFycm93IiwidGFyZ2V0UG9zaXRpb24iLCJ0YXJnZXQiLCJzcGxpdCIsImNvbnRlbnRQb3NpdGlvbiIsImNvbnRlbnQiLCJyZXN1bHQiLCJmb3JFYWNoIiwiZWxUYXJnZXRQb3NpdGlvbiIsImVsQ29udGVudFBvc2l0aW9uIiwiaXNTYW1lVGFyZ2V0UGFyYW1zIiwiaXNTYW1lQ29udGVudFBhcmFtcyIsImNhbGN1bGF0ZVBvc2l0aW9uIiwiYWxpZ25UeXBlIiwiYXJyYXlUeXBlIiwic3RhcnRQb3NpdGlvbiIsImFkZFB4IiwiTWF0aCIsInJvdW5kIiwiZ2V0QXJyb3dBbGlnbm1lbnQiLCJwYXJlbnRTaXplIiwic2l6ZSIsImdldEFycm93U3R5bGVzIiwiY29udGVudERpbWVuc2lvbnMiLCJzdHlsZSIsIm1hcmdpbiIsImlzRG93biIsImlzTGVmdCIsImlzUmlnaHQiLCJpc1VwIiwiaGFzQXJyb3ciLCJzaWRlVG9aZXJvIiwiY29sb3JTaWRlIiwidG9wIiwibGVmdCIsImhlaWdodCIsIndpZHRoIiwiUklHSFQiLCJMRUZUIiwiZ2V0U3R5bGVCeVBvc2l0aW9uIiwidGFyZ2V0RGltZW5zaW9ucyIsIndpbmRvd1dpZHRoIiwidmVydGljYWxBbGlnbiIsImhvcml6b250YWxBbGlnbiIsInRhcmdldFdpZHRoIiwidGFyZ2V0SGVpZ2h0IiwiYWRkUHhZIiwibmVlZE1vdmVDb250ZW50IiwibmVlZE1vdmVDb250ZW50WSIsIngiLCJ5IiwiY29udGVudFdpZHRoIiwiY29udGVudEhlaWdodCIsInRyYW5zZm9ybSIsInJlc3VsdFgiLCJwYXJzZUludCIsInJlcGxhY2UiLCJyZXN1bHRZIiwiaXNYVmlzaWJsZSIsImlzWVZpc2libGUiLCJpc1Zpc2libGUiLCJnZXRBbGxTdHlsZXMiLCJhcnJvd1N0eWxlcyIsInBvcG92ZXJTdHlsZXMiLCJhcnJvd1N0eWxlIiwiZ2V0UG9wb3ZlclN0eWxlIiwicG9zaXRpb25zIiwiaGlkZVRhaWwiLCJpIiwibGVuZ3RoIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0lBQ09BLFMsR0FBb0ZDLGtCLENBQXBGRCxTO0lBQVdFLFUsR0FBeUVELGtCLENBQXpFQyxVO0lBQVlDLFcsR0FBNkRGLGtCLENBQTdERSxXO0lBQWFDLGtCLEdBQWdESCxrQixDQUFoREcsa0I7SUFBb0JDLFcsR0FBNEJKLGtCLENBQTVCSSxXO0lBQWFDLFcsR0FBZUwsa0IsQ0FBZkssVztBQUU1RSxJQUFNQyxpQkFBaUIsR0FBRyxDQUFDUCxTQUFTLENBQUNRLEdBQVgsRUFBZ0JSLFNBQVMsQ0FBQ1MsTUFBMUIsRUFBa0NULFNBQVMsQ0FBQ1UsTUFBNUMsQ0FBMUI7QUFDQSxJQUFNQyxtQkFBbUIsR0FBRyxDQUFDWCxTQUFTLENBQUNZLEtBQVgsRUFBa0JaLFNBQVMsQ0FBQ1MsTUFBNUIsRUFBb0NULFNBQVMsQ0FBQ2EsR0FBOUMsQ0FBNUI7O0FBRUEsSUFBTUMsYUFBYSxHQUFHLFNBQWhCQSxhQUFnQixDQUFDQyxLQUFELEVBQVc7QUFDN0IsMkJBQWtCQSxLQUFsQjtBQUNILENBRkQ7O0FBR0EsSUFBTUMsU0FBUyxHQUFHLFNBQVpBLFNBQVksQ0FBQ0QsS0FBRCxFQUFXO0FBQ3pCLDBCQUFpQkEsS0FBakI7QUFDSCxDQUZEOztBQUdBLElBQU1FLFlBQVksR0FB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QkFBOUIsRUFBaURrQixXQUFqRCxFQUE4RDBCLFFBQTlELEVBQXdFckUsV0FBeEUsRUFBd0Y7QUFDbkgsTUFBSVEsTUFBTSxHQUFHLEVBQWI7O0FBRUEsT0FBSSxJQUFJOEQsQ0FBQyxHQUFHLENBQVosRUFBZUEsQ0FBQyxHQUFDRixTQUFTLENBQUNHLE1BQTNCLEVBQW1DRCxDQUFDLEVBQXBDLEVBQXVDO0FBQ25DLFFBQUl0QyxRQUFRLEdBQUcsQ0FBQ3FDLFFBQUQsSUFBYXZFLGtCQUFrQixDQUFDc0UsU0FBUyxDQUFDRSxDQUFELENBQVYsRUFBZXRFLFdBQWYsQ0FBOUM7QUFDQVEsSUFBQUEsTUFBTSxHQUFHdUQsWUFBWSxDQUFDSyxTQUFTLENBQUNFLENBQUQsQ0FBVixFQUFlNUIsZ0JBQWYsRUFBaUNqQixpQkFBakMsRUFBb0RrQixXQUFwRCxFQUFpRVgsUUFBakUsQ0FBckI7QUFDQSxRQUFHeEIsTUFBTSxDQUFDc0QsU0FBVixFQUNJLE1BREosS0FFSyxJQUFHUSxDQUFDLEtBQUtGLFNBQVMsQ0FBQ0csTUFBVixHQUFrQixDQUEzQixFQUNEL0QsTUFBTSxHQUFHdUQsWUFBWSxDQUFDSyxTQUFTLENBQUMsQ0FBRCxDQUFWLEVBQWUxQixnQkFBZixFQUFpQ2pCLGlCQUFqQyxFQUFvRGtCLFdBQXBELEVBQWlFWCxRQUFqRSxDQUFyQjtBQUNQOztBQUVELFNBQU94QixNQUFQO0FBQ0gsQ0FiTSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7UE9QT1ZFUn0gZnJvbSBcIi4vY29uc3RhbnRzXCI7XHJcbmNvbnN0IHtBTElHTk1FTlQsIEFSUk9XX1NJWkUsIEFSUk9XX0FMSUdOLCBOT19BUlJPV19QT1NJVElPTlMsIEFSUk9XX1NJREVTLCBBUlJPV19TUEFDRX0gPSBQT1BPVkVSXHJcblxyXG5jb25zdCB2ZXJ0aWNhbEFsaWdubWVudCA9IFtBTElHTk1FTlQuVE9QLCBBTElHTk1FTlQuQ0VOVEVSLCBBTElHTk1FTlQuQk9UVE9NXTtcclxuY29uc3QgaG9yaXpvbnRhbEFsaWdubWVudCA9IFtBTElHTk1FTlQuU1RBUlQsIEFMSUdOTUVOVC5DRU5URVIsIEFMSUdOTUVOVC5FTkRdO1xyXG5cclxuY29uc3Qgc2V0QXJyb3dDb2xvciA9IChhbGlnbikgPT4ge1xyXG4gICAgcmV0dXJuIGAtLWFycm93LSR7YWxpZ259LWNvbG9yYDtcclxufVxyXG5jb25zdCBzZXRNYXJnaW4gPSAoYWxpZ24pID0+IHtcclxuICAgIHJldHVybiBgbWFyZ2luLSR7YWxpZ259YDtcclxufVxyXG5jb25zdCBzZXRBcnJvd1NpemUgPSAoYWxpZ24pID0+IHtcclxuICAgIHJldHVybiBgLS1hcnJvdy0ke2FsaWdufS1zaXplYDtcclxufVxyXG5cclxuY29uc3QgaGFzQXJyb3dCeVBvc2l0aW9uID0gKHBvc2l0aW9uLCByb3VuZEJvcmRlcikgPT57XHJcbiAgICByZXR1cm4gIShpc09uZU9mTm9BcnJvdyhwb3NpdGlvbikgfHwgKHJvdW5kQm9yZGVyICYmICFpc0NlbnRlckFycm93KHBvc2l0aW9uKSkpO1xyXG59XHJcblxyXG5jb25zdCBpc09uZU9mTm9BcnJvdyA9IChwb3NpdGlvbikgPT4ge1xyXG4gICAgbGV0IHRhcmdldFBvc2l0aW9uID0gcG9zaXRpb24udGFyZ2V0LnNwbGl0KCctJyk7XHJcbiAgICBsZXQgY29udGVudFBvc2l0aW9uID0gcG9zaXRpb24uY29udGVudC5zcGxpdCgnLScpO1xyXG5cclxuICAgIGxldCByZXN1bHQgPSBmYWxzZTtcclxuICAgIE5PX0FSUk9XX1BPU0lUSU9OUy5mb3JFYWNoKCAoe2NvbnRlbnQsIHRhcmdldH0pID0+IHtcclxuICAgICAgICBsZXQgZWxUYXJnZXRQb3NpdGlvbiA9IHRhcmdldC5zcGxpdCgnLScpO1xyXG4gICAgICAgIGxldCBlbENvbnRlbnRQb3NpdGlvbiA9IGNvbnRlbnQuc3BsaXQoJy0nKTtcclxuICAgICAgICBsZXQgaXNTYW1lVGFyZ2V0UGFyYW1zID0gdGFyZ2V0UG9zaXRpb25bMF0gPT09IGVsVGFyZ2V0UG9zaXRpb25bMF0gJiYgdGFyZ2V0UG9zaXRpb25bMV0gPT09IGVsVGFyZ2V0UG9zaXRpb25bMV07XHJcbiAgICAgICAgbGV0IGlzU2FtZUNvbnRlbnRQYXJhbXMgPSBjb250ZW50UG9zaXRpb25bMF0gPT09IGVsQ29udGVudFBvc2l0aW9uWzBdICYmIGNvbnRlbnRQb3NpdGlvblsxXSA9PT0gZWxDb250ZW50UG9zaXRpb25bMV07XHJcblxyXG4gICAgICAgIGlmKGlzU2FtZVRhcmdldFBhcmFtcyAmJiBpc1NhbWVDb250ZW50UGFyYW1zKVxyXG4gICAgICAgICAgICByZXN1bHQgPSB0cnVlO1xyXG4gICAgfSlcclxuICAgIHJldHVybiByZXN1bHQ7XHJcbn1cclxuXHJcbmNvbnN0IGlzQ2VudGVyQXJyb3cgPSAocG9zaXRpb24pID0+IHtcclxuICAgIGxldCBjb250ZW50UG9zaXRpb24gPSBwb3NpdGlvbi5jb250ZW50LnNwbGl0KCctJyk7XHJcbiAgICByZXR1cm4gY29udGVudFBvc2l0aW9uWzBdID09PSBBTElHTk1FTlQuQ0VOVEVSIHx8IGNvbnRlbnRQb3NpdGlvblsxXSA9PT0gQUxJR05NRU5ULkNFTlRFUjtcclxufVxyXG5cclxuY29uc3QgY2FsY3VsYXRlUG9zaXRpb24gPSAoYWxpZ25UeXBlLCBhcnJheVR5cGUsIHN0YXJ0UG9zaXRpb24sIGFkZFB4ID0gMCkgPT4ge1xyXG4gICAgbGV0IHJlc3VsdCA9IGAke2FkZFB4fXB4YDtcclxuICAgIGlmKGFsaWduVHlwZSA9PT0gYXJyYXlUeXBlWzFdKVxyXG4gICAgICAgIHJlc3VsdCA9IGAke01hdGgucm91bmQoc3RhcnRQb3NpdGlvbi8yKSArIGFkZFB4fXB4YDtcclxuICAgIGVsc2UgaWYoYWxpZ25UeXBlID09PSBhcnJheVR5cGVbMl0pXHJcbiAgICAgICAgcmVzdWx0PSBgJHtzdGFydFBvc2l0aW9uICsgYWRkUHh9cHhgO1xyXG5cclxuICAgIHJldHVybiByZXN1bHQ7XHJcbn1cclxuXHJcblxyXG5jb25zdCBnZXRBcnJvd0FsaWdubWVudCA9IChhcnJheVR5cGUsIGFsaWduLCBwYXJlbnRTaXplLCBzaXplKSA9PiB7XHJcbiAgICBpZihhbGlnbiA9PT0gYXJyYXlUeXBlWzFdKVxyXG4gICAgICAgIHJldHVybiBNYXRoLnJvdW5kKHBhcmVudFNpemUvMikgLSBzaXplO1xyXG4gICAgZWxzZSBpZiAoIGFsaWduID09PSBhcnJheVR5cGVbMl0pXHJcbiAgICAgICAgcmV0dXJuIHBhcmVudFNpemUgLSBzaXplKjI7XHJcbiAgICBlbHNlXHJcbiAgICAgICAgcmV0dXJuIDA7XHJcbn1cclxuXHJcbmNvbnN0IGdldEFycm93U3R5bGVzID0gKHBvc2l0aW9uLCBjb250ZW50RGltZW5zaW9ucykgPT4ge1xyXG4gICAgbGV0IHN0eWxlID0ge307XHJcbiAgICBsZXQgdGFyZ2V0UG9zaXRpb24gPSBwb3NpdGlvbi50YXJnZXQuc3BsaXQoJy0nKTtcclxuICAgIGxldCBjb250ZW50UG9zaXRpb24gPSBwb3NpdGlvbi5jb250ZW50LnNwbGl0KCctJyk7XHJcbiAgICBsZXQgbWFyZ2luID0gYCR7QVJST1dfU0laRSArIEFSUk9XX1NQQUNFfXB4YFxyXG5cclxuICAgIGxldCBpc0Rvd24gPSB0YXJnZXRQb3NpdGlvblswXSA9PT0gQUxJR05NRU5ULlRPUCAmJiBjb250ZW50UG9zaXRpb25bMF0gPT09IEFMSUdOTUVOVC5CT1RUT007XHJcbiAgICBsZXQgaXNMZWZ0ID0gdGFyZ2V0UG9zaXRpb25bMV0gPT09IEFMSUdOTUVOVC5FTkQgJiYgY29udGVudFBvc2l0aW9uWzFdID09PSBBTElHTk1FTlQuU1RBUlQ7XHJcbiAgICBsZXQgaXNSaWdodCA9IHRhcmdldFBvc2l0aW9uWzFdID09PSBBTElHTk1FTlQuU1RBUlQgJiYgY29udGVudFBvc2l0aW9uWzFdID09PSBBTElHTk1FTlQuRU5EO1xyXG4gICAgbGV0IGlzVXAgPSB0YXJnZXRQb3NpdGlvblswXSA9PT0gQUxJR05NRU5ULkJPVFRPTSAmJiBjb250ZW50UG9zaXRpb25bMF0gPT09IEFMSUdOTUVOVC5UT1A7XHJcblxyXG4gICAgbGV0IGhhc0Fycm93ID0gdHJ1ZTtcclxuICAgIGxldCBzaWRlVG9aZXJvID0gbnVsbDtcclxuICAgIGxldCBjb2xvclNpZGUgPSBudWxsO1xyXG4gICAgbGV0IHRvcCA9IDA7XHJcbiAgICBsZXQgbGVmdCA9IDA7XHJcblxyXG4gICAgc3dpdGNoKHRydWUpe1xyXG4gICAgICAgIGNhc2UgaXNEb3duIDpcclxuICAgICAgICAgICAgc2lkZVRvWmVybyA9IEFSUk9XX1NJREVTLkJPVFRPTTtcclxuICAgICAgICAgICAgY29sb3JTaWRlID0gQVJST1dfU0lERVMuVE9QO1xyXG5cclxuICAgICAgICAgICAgdG9wID0gY29udGVudERpbWVuc2lvbnMuaGVpZ2h0O1xyXG4gICAgICAgICAgICBsZWZ0ID0gZ2V0QXJyb3dBbGlnbm1lbnQoaG9yaXpvbnRhbEFsaWdubWVudCwgY29udGVudFBvc2l0aW9uWzFdLCBjb250ZW50RGltZW5zaW9ucy53aWR0aCwgQVJST1dfU0laRSk7XHJcblxyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICBjYXNlIGlzUmlnaHQgOlxyXG4gICAgICAgICAgICBzaWRlVG9aZXJvID0gQVJST1dfU0lERVMuUklHSFQ7XHJcbiAgICAgICAgICAgIGNvbG9yU2lkZSA9IEFSUk9XX1NJREVTLkxFRlQ7XHJcblxyXG4gICAgICAgICAgICB0b3AgPSBnZXRBcnJvd0FsaWdubWVudCh2ZXJ0aWNhbEFsaWdubWVudCwgY29udGVudFBvc2l0aW9uWzBdLCBjb250ZW50RGltZW5zaW9ucy5oZWlnaHQsIEFSUk9XX1NJWkUpO1xyXG4gICAgICAgICAgICBsZWZ0ID0gY29udGVudERpbWVuc2lvbnMud2lkdGg7XHJcblxyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICBjYXNlIGlzTGVmdDpcclxuICAgICAgICAgICAgc2lkZVRvWmVybyA9IEFSUk9XX1NJREVTLkxFRlQ7XHJcbiAgICAgICAgICAgIGNvbG9yU2lkZSA9IEFSUk9XX1NJREVTLlJJR0hUO1xyXG5cclxuICAgICAgICAgICAgdG9wID0gZ2V0QXJyb3dBbGlnbm1lbnQodmVydGljYWxBbGlnbm1lbnQsIGNvbnRlbnRQb3NpdGlvblswXSwgY29udGVudERpbWVuc2lvbnMuaGVpZ2h0LCBBUlJPV19TSVpFKTtcclxuICAgICAgICAgICAgbGVmdCA9IC1BUlJPV19TSVpFO1xyXG5cclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSBpc1VwOlxyXG4gICAgICAgICAgICBzaWRlVG9aZXJvID0gQVJST1dfU0lERVMuVE9QO1xyXG4gICAgICAgICAgICBjb2xvclNpZGUgPSBBUlJPV19TSURFUy5CT1RUT007XHJcblxyXG4gICAgICAgICAgICB0b3AgPSAtQVJST1dfU0laRTtcclxuICAgICAgICAgICAgbGVmdCA9IGdldEFycm93QWxpZ25tZW50KGhvcml6b250YWxBbGlnbm1lbnQsIGNvbnRlbnRQb3NpdGlvblsxXSwgY29udGVudERpbWVuc2lvbnMud2lkdGgsIEFSUk9XX1NJWkUpO1xyXG5cclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgaGFzQXJyb3cgPSBmYWxzZTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICB9XHJcblxyXG4gICAgaWYoaGFzQXJyb3cpe1xyXG4gICAgICAgIHN0eWxlW0FSUk9XX0FMSUdOLlRPUF0gPSBgJHt0b3B9cHhgO1xyXG4gICAgICAgIHN0eWxlW0FSUk9XX0FMSUdOLkxFRlRdID0gYCR7bGVmdH1weGA7XHJcblxyXG4gICAgICAgIHN0eWxlW3NldEFycm93Q29sb3IoY29sb3JTaWRlKV0gPSAndmFyKC0tcG9wb3Zlci1iYWNrZ3JvdW5kKSc7XHJcbiAgICAgICAgc3R5bGVbc2V0QXJyb3dTaXplKHNpZGVUb1plcm8pXSA9IDA7XHJcbiAgICAgICAgc3R5bGVbc2V0TWFyZ2luKHNpZGVUb1plcm8pXSA9IG1hcmdpbjtcclxuICAgIH1cclxuICAgIHJldHVybiB7aGFzQXJyb3c6IGhhc0Fycm93LCBzdHlsZTogc3R5bGV9O1xyXG59XHJcblxyXG5jb25zdCBnZXRTdHlsZUJ5UG9zaXRpb24gPSAocG9zaXRpb24sIHRhcmdldERpbWVuc2lvbnMsIGNvbnRlbnREaW1lbnNpb25zLCB3aW5kb3dXaWR0aCwgaGFzQXJyb3cpID0+IHtcclxuICAgIGxldCBzdHlsZSA9IHt9O1xyXG4gICAgbGV0IHRhcmdldFBvc2l0aW9uID0gcG9zaXRpb24udGFyZ2V0LnNwbGl0KCctJyk7XHJcbiAgICBsZXQgY29udGVudFBvc2l0aW9uID0gcG9zaXRpb24uY29udGVudC5zcGxpdCgnLScpO1xyXG5cclxuICAgIGlmKHRhcmdldFBvc2l0aW9uKXtcclxuICAgICAgICBsZXQgdmVydGljYWxBbGlnbiA9IHRhcmdldFBvc2l0aW9uWzBdO1xyXG4gICAgICAgIGxldCBob3Jpem9udGFsQWxpZ24gPSB0YXJnZXRQb3NpdGlvblsxXTtcclxuXHJcbiAgICAgICAgbGV0IHRhcmdldFdpZHRoID0gdGFyZ2V0RGltZW5zaW9ucy53aWR0aDtcclxuICAgICAgICBsZXQgdGFyZ2V0SGVpZ2h0ID0gdGFyZ2V0RGltZW5zaW9ucy5oZWlnaHQ7XHJcblxyXG4gICAgICAgIGxldCBhZGRQeCA9IDA7XHJcbiAgICAgICAgbGV0IGFkZFB4WSA9IDBcclxuXHJcbiAgICAgICAgbGV0IG5lZWRNb3ZlQ29udGVudCA9IHZlcnRpY2FsQWxpZ24gPT09IEFMSUdOTUVOVC5UT1AgJiYgY29udGVudFBvc2l0aW9uWzBdID09PSBBTElHTk1FTlQuQk9UVE9NO1xyXG4gICAgICAgIGxldCBuZWVkTW92ZUNvbnRlbnRZID0gaG9yaXpvbnRhbEFsaWduID09PSBBTElHTk1FTlQuU1RBUlQgJiYgY29udGVudFBvc2l0aW9uWzFdID09PSBBTElHTk1FTlQuRU5EO1xyXG5cclxuICAgICAgICBpZihuZWVkTW92ZUNvbnRlbnQgJiYgaGFzQXJyb3cpXHJcbiAgICAgICAgICAgIGFkZFB4ID0gLUFSUk9XX1NJWkUgLSBBUlJPV19TUEFDRTtcclxuXHJcbiAgICAgICAgaWYobmVlZE1vdmVDb250ZW50WSAmJiBoYXNBcnJvdylcclxuICAgICAgICAgICAgYWRkUHhZID0gLUFSUk9XX1NJWkUgLSBBUlJPV19TUEFDRTtcclxuXHJcbiAgICAgICAgc3R5bGUudG9wID0gY2FsY3VsYXRlUG9zaXRpb24odmVydGljYWxBbGlnbiwgdmVydGljYWxBbGlnbm1lbnQsIHRhcmdldEhlaWdodCwgYWRkUHgpO1xyXG4gICAgICAgIHN0eWxlLmxlZnQgPSBjYWxjdWxhdGVQb3NpdGlvbihob3Jpem9udGFsQWxpZ24sIGhvcml6b250YWxBbGlnbm1lbnQsIHRhcmdldFdpZHRoLCBhZGRQeFkpO1xyXG5cclxuICAgIH1cclxuXHJcbiAgICBsZXQgeCwgeTtcclxuICAgIGlmKGNvbnRlbnRQb3NpdGlvbil7XHJcbiAgICAgICAgbGV0IHZlcnRpY2FsQWxpZ24gPSBjb250ZW50UG9zaXRpb25bMF07XHJcbiAgICAgICAgbGV0IGhvcml6b250YWxBbGlnbiA9IGNvbnRlbnRQb3NpdGlvblsxXTtcclxuXHJcbiAgICAgICAgbGV0IGNvbnRlbnRXaWR0aCA9IGNvbnRlbnREaW1lbnNpb25zLndpZHRoO1xyXG4gICAgICAgIGxldCBjb250ZW50SGVpZ2h0ID0gY29udGVudERpbWVuc2lvbnMuaGVpZ2h0O1xyXG5cclxuICAgICAgICB5ID0gY2FsY3VsYXRlUG9zaXRpb24odmVydGljYWxBbGlnbiwgdmVydGljYWxBbGlnbm1lbnQsIC1jb250ZW50SGVpZ2h0KTtcclxuICAgICAgICB4ID0gY2FsY3VsYXRlUG9zaXRpb24oaG9yaXpvbnRhbEFsaWduLCBob3Jpem9udGFsQWxpZ25tZW50LCAtY29udGVudFdpZHRoKTtcclxuXHJcbiAgICAgICAgc3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZTNkKCR7eH0sICR7eX0sIDApYDtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgcmVzdWx0WCA9IHRhcmdldERpbWVuc2lvbnMueCArXHJcbiAgICAgICAgcGFyc2VJbnQoc3R5bGUubGVmdC5yZXBsYWNlKFwicHhcIiwgJycpKSArXHJcbiAgICAgICAgcGFyc2VJbnQoeC5yZXBsYWNlKFwicHhcIiwgJycpKTtcclxuXHJcbiAgICBsZXQgcmVzdWx0WSA9IHRhcmdldERpbWVuc2lvbnMueSArXHJcbiAgICAgICAgcGFyc2VJbnQoc3R5bGUudG9wLnJlcGxhY2UoXCJweFwiLCAnJykpICtcclxuICAgICAgICBwYXJzZUludCh5LnJlcGxhY2UoXCJweFwiLCAnJykpO1xyXG5cclxuICAgIGxldCBpc1hWaXNpYmxlID0gcmVzdWx0WD4wICYmIChyZXN1bHRYICsgY29udGVudERpbWVuc2lvbnMud2lkdGgpIDwgd2luZG93V2lkdGg7XHJcbiAgICBsZXQgaXNZVmlzaWJsZSA9IHJlc3VsdFk+MDtcclxuXHJcbiAgICBsZXQgaXNWaXNpYmxlID0gaXNYVmlzaWJsZSAmJiBpc1lWaXNpYmxlO1xyXG5cclxuICAgIHJldHVybiB7c3R5bGU6IHN0eWxlLCBpc1Zpc2libGU6IGlzVmlzaWJsZX07XHJcbn1cclxuXHJcbmNvbnN0IGdldEFsbFN0eWxlcyA9IChwb3NpdGlvbiwgdGFyZ2V0RGltZW5zaW9ucywgY29udGVudERpbWVuc2lvbnMsIHdpbmRvd1dpZHRoLCBoYXNBcnJvdykgPT4ge1xyXG4gICAgbGV0IGFycm93U3R5bGVzID0geyBoYXNBcnJvdzogZmFsc2UsIHN0eWxlOnt9fTtcclxuICAgIGxldCBwb3BvdmVyU3R5bGVzID0gZ2V0U3R5bGVCeVBvc2l0aW9uKHBvc2l0aW9uLCB0YXJnZXREaW1lbnNpb25zLCBjb250ZW50RGltZW5zaW9ucywgd2luZG93V2lkdGgsIGhhc0Fycm93KTtcclxuICAgIGlmKGhhc0Fycm93ICYmIHBvcG92ZXJTdHlsZXMuaXNWaXNpYmxlKVxyXG4gICAgICAgIGFycm93U3R5bGVzID0gZ2V0QXJyb3dTdHlsZXMocG9zaXRpb24sIGNvbnRlbnREaW1lbnNpb25zKTtcclxuXHJcbiAgICByZXR1cm4ge2lzVmlzaWJsZTogcG9wb3ZlclN0eWxlcy5pc1Zpc2libGUsIHN0eWxlOiBwb3BvdmVyU3R5bGVzLnN0eWxlLCBoYXNBcnJvdzogYXJyb3dTdHlsZXMuaGFzQXJyb3csIGFycm93U3R5bGU6IGFycm93U3R5bGVzLnN0eWxlfTtcclxufVxyXG5cclxuXHJcbmV4cG9ydCBjb25zdCBnZXRQb3BvdmVyU3R5bGUgPSAocG9zaXRpb25zLCB0YXJnZXREaW1lbnNpb25zLCBjb250ZW50RGltZW5zaW9ucywgd2luZG93V2lkdGgsIGhpZGVUYWlsLCByb3VuZEJvcmRlcikgPT4ge1xyXG4gICAgbGV0IHJlc3VsdCA9IHt9O1xyXG5cclxuICAgIGZvcihsZXQgaSA9IDA7IGk8cG9zaXRpb25zLmxlbmd0aDsgaSsrKXtcclxuICAgICAgICBsZXQgaGFzQXJyb3cgPSAhaGlkZVRhaWwgJiYgaGFzQXJyb3dCeVBvc2l0aW9uKHBvc2l0aW9uc1tpXSwgcm91bmRCb3JkZXIpO1xyXG4gICAgICAgIHJlc3VsdCA9IGdldEFsbFN0eWxlcyhwb3NpdGlvbnNbaV0sIHRhcmdldERpbWVuc2lvbnMsIGNvbnRlbnREaW1lbnNpb25zLCB3aW5kb3dXaWR0aCwgaGFzQXJyb3cpO1xyXG4gICAgICAgIGlmKHJlc3VsdC5pc1Zpc2libGUpXHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGVsc2UgaWYoaSA9PT0gcG9zaXRpb25zLmxlbmd0aCAtMSlcclxuICAgICAgICAgICAgcmVzdWx0ID0gZ2V0QWxsU3R5bGVzKHBvc2l0aW9uc1swXSwgdGFyZ2V0RGltZW5zaW9ucywgY29udGVudERpbWVuc2lvbnMsIHdpbmRvd1dpZHRoLCBoYXNBcnJvdyk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHJlc3VsdDtcclxufSJdfQ==