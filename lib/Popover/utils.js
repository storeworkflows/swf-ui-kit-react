"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getPopoverStyle = void 0;
var alignment = {
  TOP: "top",
  CENTER: "center",
  BOTTOM: "bottom",
  START: "start",
  END: "end"
};
var verticalAlignment = [alignment.TOP, alignment.CENTER, alignment.BOTTOM];
var horizontalAlignment = [alignment.START, alignment.CENTER, alignment.END];
var noArrow = [{
  target: "top-start",
  content: "bottom-end"
}, {
  target: "top-end",
  content: "bottom-start"
}, {
  target: "bottom-end",
  content: "top-start"
}, {
  target: "bottom-start",
  content: "top-end"
}];
var arrowBorder = {
  RIGHT: '--popover-arrow-border-right',
  LEFT: '--popover-arrow-border-left',
  BOTTOM: '--popover-arrow-border-bottom',
  TOP: '--popover-arrow-border-top'
};
var arrowAlign = {
  TOP: '--popover-arrow-top',
  LEFT: '--popover-arrow-left'
};
var arrowSize = 16;
var arrowBorderWidth = 1;
var diagonal = (arrowSize + 2 * arrowBorderWidth) * Math.sqrt(2);
var halfDiagonal = diagonal / 2;

var isOneOfNoArrow = function isOneOfNoArrow(position) {
  var targetPosition = position.target.split('-');
  var contentPosition = position.content.split('-');
  var result = false;
  noArrow.forEach(function (_ref) {
    var content = _ref.content,
        target = _ref.target;
    var elTargetPosition = target.split('-');
    var elContentPosition = content.split('-');
    var isSameTargetParams = targetPosition[0] === elTargetPosition[0] && targetPosition[1] === elTargetPosition[1];
    var isSameContentParams = contentPosition[0] === elContentPosition[0] && contentPosition[1] === elContentPosition[1];
    if (isSameTargetParams && isSameContentParams) result = true;
  });
  return result;
};

var calculatePosition = function calculatePosition(alignType, arrayType, startPosition) {
  var addPx = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : 0;
  var result = "".concat(addPx, "px");
  if (alignType === arrayType[1]) result = "".concat(startPosition / 2 + addPx, "px");else if (alignType === arrayType[2]) result = "".concat(startPosition + addPx, "px");
  return result;
};

var calculateArrowPosition = function calculateArrowPosition(alignType, arrayType, startPosition) {
  var additionalParam = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : 0;
  var result = "".concat(additionalParam + 8, "px ");
  if (alignType === arrayType[1]) result = "".concat(startPosition / 2 - halfDiagonal + additionalParam + 2, "px");else if (alignType === arrayType[2]) result = "".concat(startPosition - diagonal + additionalParam - 5, "px");
  return result;
};

var getArrowStyles = function getArrowStyles(position, contentDimensions) {
  var style = {};
  var borderStyle = "".concat(arrowBorderWidth, "px solid rgba(0, 0, 0, 0.3)");
  var targetPosition = position.target.split('-');
  var contentPosition = position.content.split('-');
  var hasArrow = true;
  var margin = "".concat(halfDiagonal, "px");
  if (isOneOfNoArrow(position)) hasArrow = false;else if (targetPosition[0] === alignment.TOP && contentPosition[0] === alignment.BOTTOM) {
    //down
    style[arrowBorder.BOTTOM] = borderStyle;
    style[arrowBorder.RIGHT] = borderStyle;
    style[arrowAlign.TOP] = contentDimensions.height + "px";
    style[arrowAlign.LEFT] = calculateArrowPosition(contentPosition[1], horizontalAlignment, contentDimensions.width);
    style['margin-bottom'] = margin;
  } else if (targetPosition[1] === alignment.START && contentPosition[1] === alignment.END) {
    //right
    style[arrowBorder.RIGHT] = borderStyle;
    style[arrowBorder.TOP] = borderStyle;
    style[arrowAlign.TOP] = calculateArrowPosition(contentPosition[0], verticalAlignment, contentDimensions.height, halfDiagonal);
    style[arrowAlign.LEFT] = "".concat(contentDimensions.width - halfDiagonal + 2, "px");
    style['margin-right'] = margin;
  } else if (targetPosition[1] === alignment.END && contentPosition[1] === alignment.START) {
    //left
    style[arrowBorder.LEFT] = borderStyle;
    style[arrowBorder.BOTTOM] = borderStyle;
    style[arrowAlign.TOP] = "".concat(calculateArrowPosition(contentPosition[0], verticalAlignment, contentDimensions.height, halfDiagonal));
    style[arrowAlign.LEFT] = "".concat(-halfDiagonal + 2, "px");
    style['margin-left'] = margin;
  } else if (targetPosition[0] === alignment.BOTTOM && contentPosition[0] === alignment.TOP) {
    //up
    style[arrowBorder.LEFT] = borderStyle;
    style[arrowBorder.TOP] = borderStyle;
    style[arrowAlign.TOP] = 0;
    style[arrowAlign.LEFT] = calculateArrowPosition(contentPosition[1], horizontalAlignment, contentDimensions.width);
    style['margin-top'] = margin;
  } else hasArrow = false;
  return {
    hasArrow: hasArrow,
    style: style
  };
};

var getStyleByPosition = function getStyleByPosition(position, targetDimensions, contentDimensions, windowWidth, hideTail) {
  var style = {};
  var targetPosition = position.target.split('-');
  var contentPosition = position.content.split('-');

  if (targetPosition) {
    var verticalAlign = targetPosition[0];
    var horizontalAlign = targetPosition[1];
    var targetWidth = targetDimensions.width;
    var targetHeight = targetDimensions.height;
    var addPx = 0;
    var addPxY = 0;
    var needMoveContent = verticalAlign === alignment.TOP && contentPosition[0] === alignment.BOTTOM;
    var needMoveContentY = horizontalAlign === alignment.START && contentPosition[1] === alignment.END;
    if (needMoveContent && !hideTail && !isOneOfNoArrow(position)) addPx = -halfDiagonal;
    if (needMoveContentY && !hideTail && !isOneOfNoArrow(position)) addPxY = -halfDiagonal;
    style.top = calculatePosition(verticalAlign, verticalAlignment, targetHeight, addPx);
    style.left = calculatePosition(horizontalAlign, horizontalAlignment, targetWidth, addPxY);
  }

  var x, y;

  if (contentPosition) {
    var _verticalAlign = contentPosition[0];
    var _horizontalAlign = contentPosition[1];
    var contentWidth = contentDimensions.width;
    var contentHeight = contentDimensions.height;
    y = calculatePosition(_verticalAlign, verticalAlignment, -contentHeight);
    x = calculatePosition(_horizontalAlign, horizontalAlignment, -contentWidth);
    style.transform = "translate3d(".concat(x, ", ").concat(y, ", 0)");
  }

  var resultX = targetDimensions.x + parseInt(style.left.replace("px", '')) + parseInt(x.replace("px", ''));
  var resultY = targetDimensions.y + parseInt(style.top.replace("px", '')) + parseInt(y.replace("px", ''));
  var isXVisible = resultX > 0 && resultX + contentDimensions.width < windowWidth;
  var isYVisible = resultY > 0;
  var isVisible = isXVisible && isYVisible;
  console.log("visibility", isVisible);
  return {
    style: style,
    isVisible: isVisible
  };
};

var getPopoverStyle = function getPopoverStyle(positions, targetDimensions, contentDimensions, windowWidth, hideTail) {
  var style = {};
  var result;
  var arrowStyles = {
    hasArrow: false,
    style: {}
  };

  for (var i = 0; i < positions.length; i++) {
    result = getStyleByPosition(positions[i], targetDimensions, contentDimensions, windowWidth, hideTail);

    if (result.isVisible) {
      style = result.style;
      if (!hideTail) arrowStyles = getArrowStyles(positions[i], contentDimensions);
      break;
    } else if (i === positions.length - 1) {
      style = getStyleByPosition(positions[0], targetDimensions, contentDimensions, windowWidth, hideTail).style;
      if (!hideTail) arrowStyles = getArrowStyles(positions[0], contentDimensions);
    }
  }

  return {
    style: style,
    hasArrow: arrowStyles.hasArrow,
    arrowStyle: arrowStyles.style
  };
};

exports.getPopoverStyle = getPopoverStyle;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Qb3BvdmVyL3V0aWxzLmpzIl0sIm5hbWVzIjpbImFsaWdubWVudCIsIlRPUCIsIkNFTlRFUiIsIkJPVFRPTSIsIlNUQVJUIiwiRU5EIiwidmVydGljYWxBbGlnbm1lbnQiLCJob3Jpem9udGFsQWxpZ25tZW50Iiwibm9BcnJvdyIsInRhcmdldCIsImNvbnRlbnQiLCJhcnJvd0JvcmRlciIsIlJJR0hUIiwiTEVGVCIsImFycm93QWxpZ24iLCJhcnJvd1NpemUiLCJhcnJvd0JvcmRlcldpZHRoIiwiZGlhZ29uYWwiLCJNYXRoIiwic3FydCIsImhhbGZEaWFnb25hbCIsImlzT25lT2ZOb0Fycm93IiwicG9zaXRpb24iLCJ0YXJnZXRQb3NpdGlvbiIsInNwbGl0IiwiY29udGVudFBvc2l0aW9uIiwicmVzdWx0IiwiZm9yRWFjaCIsImVsVGFyZ2V0UG9zaXRpb24iLCJlbENvbnRlbnRQb3NpdGlvbiIsImlzU2FtZVRhcmdldFBhcmFtcyIsImlzU2FtZUNvbnRlbnRQYXJhbXMiLCJjYWxjdWxhdGVQb3NpdGlvbiIsImFsaWduVHlwZSIsImFycmF5VHlwZSIsInN0YXJ0UG9zaXRpb24iLCJhZGRQeCIsImNhbGN1bGF0ZUFycm93UG9zaXRpb24iLCJhZGRpdGlvbmFsUGFyYW0iLCJnZXRBcnJvd1N0eWxlcyIsImNvbnRlbnREaW1lbnNpb25zIiwic3R5bGUiLCJib3JkZXJTdHlsZSIsImhhc0Fycm93IiwibWFyZ2luIiwiaGVpZ2h0Iiwid2lkdGgiLCJnZXRTdHlsZUJ5UG9zaXRpb24iLCJ0YXJnZXREaW1lbnNpb25zIiwid2luZG93V2lkdGgiLCJoaWRlVGFpbCIsInZlcnRpY2FsQWxpZ24iLCJob3Jpem9udGFsQWxpZ24iLCJ0YXJnZXRXaWR0aCIsInRhcmdldEhlaWdodCIsImFkZFB4WSIsIm5lZWRNb3ZlQ29udGVudCIsIm5lZWRNb3ZlQ29udGVudFkiLCJ0b3AiLCJsZWZ0IiwieCIsInkiLCJjb250ZW50V2lkdGgiLCJjb250ZW50SGVpZ2h0IiwidHJhbnNmb3JtIiwicmVzdWx0WCIsInBhcnNlSW50IiwicmVwbGFjZSIsInJlc3VsdFkiLCJpc1hWaXNpYmxlIiwiaXNZVmlzaWJsZSIsImlzVmlzaWJsZSIsImNvbnNvbGUiLCJsb2ciLCJnZXRQb3BvdmVyU3R5bGUiLCJwb3NpdGlvbnMiLCJhcnJvd1N0eWxlcyIsImkiLCJsZW5ndGgiLCJhcnJvd1N0eWxlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxJQUFNQSxTQUFTLEdBQUc7QUFDZEMsRUFBQUEsR0FBRyxFQUFFLEtBRFM7QUFFZEMsRUFBQUEsTUFBTSxFQUFFLFFBRk07QUFHZEMsRUFBQUEsTUFBTSxFQUFFLFFBSE07QUFJZEMsRUFBQUEsS0FBSyxFQUFFLE9BSk87QUFLZEMsRUFBQUEsR0FBRyxFQUFFO0FBTFMsQ0FBbEI7QUFRQSxJQUFNQyxpQkFBaUIsR0FBRyxDQUFDTixTQUFTLENBQUNDLEdBQVgsRUFBZ0JELFNBQVMsQ0FBQ0UsTUFBMUIsRUFBa0NGLFNBQVMsQ0FBQ0csTUFBNUMsQ0FBMUI7QUFDQSxJQUFNSSxtQkFBbUIsR0FBRyxDQUFDUCxTQUFTLENBQUNJLEtBQVgsRUFBa0JKLFNBQVMsQ0FBQ0UsTUFBNUIsRUFBb0NGLFNBQVMsQ0FBQ0ssR0FBOUMsQ0FBNUI7QUFDQSxJQUFNRyxPQUFPLEdBQUcsQ0FBQztBQUFDQyxFQUFBQSxNQUFNLEVBQUUsV0FBVDtBQUFzQkMsRUFBQUEsT0FBTyxFQUFFO0FBQS9CLENBQUQsRUFDWjtBQUFDRCxFQUFBQSxNQUFNLEVBQUUsU0FBVDtBQUFvQkMsRUFBQUEsT0FBTyxFQUFFO0FBQTdCLENBRFksRUFFWjtBQUFDRCxFQUFBQSxNQUFNLEVBQUUsWUFBVDtBQUF1QkMsRUFBQUEsT0FBTyxFQUFFO0FBQWhDLENBRlksRUFHWjtBQUFDRCxFQUFBQSxNQUFNLEVBQUUsY0FBVDtBQUF5QkMsRUFBQUEsT0FBTyxFQUFFO0FBQWxDLENBSFksQ0FBaEI7QUFNQSxJQUFNQyxXQUFXLEdBQUc7QUFDaEJDLEVBQUFBLEtBQUssRUFBRSw4QkFEUztB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TSxDQUFDNkMsU0FBVixFQUNBO0FBQ0k5QixNQUFBQSxLQUFLLEdBQUdmLE1BQU0sQ0FBQ2UsS0FBZjtBQUNBLFVBQUcsQ0FBQ1MsUUFBSixFQUNJMEIsV0FBVyxHQUFHckMsY0FBYyxDQUFFb0MsU0FBUyxDQUFDRSxDQUFELENBQVgsRUFBZ0JyQyxpQkFBaEIsQ0FBNUI7QUFDSjtBQUNILEtBTkQsTUFNTSxJQUFHcUMsQ0FBQyxLQUFLRixTQUFTLENBQUNHLE1BQVYsR0FBa0IsQ0FBM0IsRUFDTjtBQUNJckMsTUFBQUEsS0FBSyxHQUFHTSxrQkFBa0IsQ0FBQzRCLFNBQVMsQ0FBQyxDQUFELENBQVYsRUFBZTNCLGdCQUFmLEVBQWlDUixpQkFBakMsRUFBb0RTLFdBQXBELEVBQWlFQyxRQUFqRSxDQUFsQixDQUE2RlQsS0FBckc7QUFDQSxVQUFHLENBQUNTLFFBQUosRUFDSTBCLFdBQVcsR0FBR3JDLGNBQWMsQ0FBRW9DLFNBQVMsQ0FBQyxDQUFELENBQVgsRUFBZ0JuQyxpQkFBaEIsQ0FBNUI7QUFDUDtBQUNKOztBQUdELFNBQU87QUFBQ0MsSUFBQUEsS0FBSyxFQUFFQSxLQUFSO0FBQWVFLElBQUFBLFFBQVEsRUFBRWlDLFdBQVcsQ0FBQ2pDLFFBQXJDO0FBQStDb0MsSUFBQUEsVUFBVSxFQUFFSCxXQUFXLENBQUNuQztBQUF2RSxHQUFQO0FBQ0gsQ0F2Qk0iLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBhbGlnbm1lbnQgPSB7XHJcbiAgICBUT1A6IFwidG9wXCIsXHJcbiAgICBDRU5URVI6IFwiY2VudGVyXCIsXHJcbiAgICBCT1RUT006IFwiYm90dG9tXCIsXHJcbiAgICBTVEFSVDogXCJzdGFydFwiLFxyXG4gICAgRU5EOiBcImVuZFwiXHJcbn1cclxuXHJcbmNvbnN0IHZlcnRpY2FsQWxpZ25tZW50ID0gW2FsaWdubWVudC5UT1AsIGFsaWdubWVudC5DRU5URVIsIGFsaWdubWVudC5CT1RUT01dO1xyXG5jb25zdCBob3Jpem9udGFsQWxpZ25tZW50ID0gW2FsaWdubWVudC5TVEFSVCwgYWxpZ25tZW50LkNFTlRFUiwgYWxpZ25tZW50LkVORF07XHJcbmNvbnN0IG5vQXJyb3cgPSBbe3RhcmdldDogXCJ0b3Atc3RhcnRcIiwgY29udGVudDogXCJib3R0b20tZW5kXCJ9LFxyXG4gICAge3RhcmdldDogXCJ0b3AtZW5kXCIsIGNvbnRlbnQ6IFwiYm90dG9tLXN0YXJ0XCJ9LFxyXG4gICAge3RhcmdldDogXCJib3R0b20tZW5kXCIsIGNvbnRlbnQ6IFwidG9wLXN0YXJ0XCJ9LFxyXG4gICAge3RhcmdldDogXCJib3R0b20tc3RhcnRcIiwgY29udGVudDogXCJ0b3AtZW5kXCJ9XHJcbl1cclxuXHJcbmNvbnN0IGFycm93Qm9yZGVyID0ge1xyXG4gICAgUklHSFQ6ICctLXBvcG92ZXItYXJyb3ctYm9yZGVyLXJpZ2h0JyxcclxuICAgIExFRlQ6ICctLXBvcG92ZXItYXJyb3ctYm9yZGVyLWxlZnQnLFxyXG4gICAgQk9UVE9NOiAnLS1wb3BvdmVyLWFycm93LWJvcmRlci1ib3R0b20nLFxyXG4gICAgVE9QOiAnLS1wb3BvdmVyLWFycm93LWJvcmRlci10b3AnLFxyXG59XHJcblxyXG5jb25zdCBhcnJvd0FsaWduID0ge1xyXG4gICAgVE9QOiAnLS1wb3BvdmVyLWFycm93LXRvcCcsXHJcbiAgICBMRUZUOiAnLS1wb3BvdmVyLWFycm93LWxlZnQnLFxyXG59XHJcblxyXG5jb25zdCBhcnJvd1NpemUgPSAxNjtcclxuY29uc3QgYXJyb3dCb3JkZXJXaWR0aCA9IDE7XHJcbmNvbnN0IGRpYWdvbmFsID0gKGFycm93U2l6ZSArIDIgKiBhcnJvd0JvcmRlcldpZHRoKSAqIE1hdGguc3FydCgyKTtcclxuY29uc3QgaGFsZkRpYWdvbmFsID0gZGlhZ29uYWwvMjtcclxuXHJcbmNvbnN0IGlzT25lT2ZOb0Fycm93ID0gKHBvc2l0aW9uKSA9PiB7XHJcbiAgICBsZXQgdGFyZ2V0UG9zaXRpb24gPSBwb3NpdGlvbi50YXJnZXQuc3BsaXQoJy0nKTtcclxuICAgIGxldCBjb250ZW50UG9zaXRpb24gPSBwb3NpdGlvbi5jb250ZW50LnNwbGl0KCctJyk7XHJcblxyXG4gICAgbGV0IHJlc3VsdCA9IGZhbHNlO1xyXG4gICAgbm9BcnJvdy5mb3JFYWNoKCAoe2NvbnRlbnQsIHRhcmdldH0pID0+IHtcclxuICAgICAgICBsZXQgZWxUYXJnZXRQb3NpdGlvbiA9IHRhcmdldC5zcGxpdCgnLScpO1xyXG4gICAgICAgIGxldCBlbENvbnRlbnRQb3NpdGlvbiA9IGNvbnRlbnQuc3BsaXQoJy0nKTtcclxuICAgICAgICBsZXQgaXNTYW1lVGFyZ2V0UGFyYW1zID0gdGFyZ2V0UG9zaXRpb25bMF0gPT09IGVsVGFyZ2V0UG9zaXRpb25bMF0gJiYgdGFyZ2V0UG9zaXRpb25bMV0gPT09IGVsVGFyZ2V0UG9zaXRpb25bMV07XHJcbiAgICAgICAgbGV0IGlzU2FtZUNvbnRlbnRQYXJhbXMgPSBjb250ZW50UG9zaXRpb25bMF0gPT09IGVsQ29udGVudFBvc2l0aW9uWzBdICYmIGNvbnRlbnRQb3NpdGlvblsxXSA9PT0gZWxDb250ZW50UG9zaXRpb25bMV07XHJcblxyXG4gICAgICAgIGlmKGlzU2FtZVRhcmdldFBhcmFtcyAmJiBpc1NhbWVDb250ZW50UGFyYW1zKVxyXG4gICAgICAgICAgICByZXN1bHQgPSB0cnVlO1xyXG4gICAgfSlcclxuICAgIHJldHVybiByZXN1bHQ7XHJcbn1cclxuXHJcbmNvbnN0IGNhbGN1bGF0ZVBvc2l0aW9uID0gKGFsaWduVHlwZSwgYXJyYXlUeXBlLCBzdGFydFBvc2l0aW9uLCBhZGRQeCA9IDApID0+IHtcclxuICAgIGxldCByZXN1bHQgPSBgJHthZGRQeH1weGA7XHJcbiAgICBpZihhbGlnblR5cGUgPT09IGFycmF5VHlwZVsxXSlcclxuICAgICAgICByZXN1bHQgPSBgJHtzdGFydFBvc2l0aW9uLzIgKyBhZGRQeH1weGA7XHJcbiAgICBlbHNlIGlmKGFsaWduVHlwZSA9PT0gYXJyYXlUeXBlWzJdKVxyXG4gICAgICAgIHJlc3VsdD0gYCR7c3RhcnRQb3NpdGlvbiArIGFkZFB4fXB4YDtcclxuXHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG59XHJcblxyXG5jb25zdCBjYWxjdWxhdGVBcnJvd1Bvc2l0aW9uID0gKGFsaWduVHlwZSwgYXJyYXlUeXBlLCBzdGFydFBvc2l0aW9uLCBhZGRpdGlvbmFsUGFyYW0gPSAwKSA9PiB7XHJcbiAgICBsZXQgcmVzdWx0ID0gYCR7YWRkaXRpb25hbFBhcmFtICsgOH1weCBgO1xyXG4gICAgaWYoYWxpZ25UeXBlID09PSBhcnJheVR5cGVbMV0pXHJcbiAgICAgICAgcmVzdWx0ID0gYCR7c3RhcnRQb3NpdGlvbi8yIC0gaGFsZkRpYWdvbmFsICsgYWRkaXRpb25hbFBhcmFtICsyfXB4YDtcclxuICAgIGVsc2UgaWYoYWxpZ25UeXBlID09PSBhcnJheVR5cGVbMl0pXHJcbiAgICAgICAgcmVzdWx0PSBgJHtzdGFydFBvc2l0aW9uIC0gZGlhZ29uYWwgKyBhZGRpdGlvbmFsUGFyYW0gLSA1fXB4YDtcclxuXHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG59XHJcblxyXG5jb25zdCBnZXRBcnJvd1N0eWxlcyA9IChwb3NpdGlvbiwgY29udGVudERpbWVuc2lvbnMpID0+IHtcclxuICAgIGxldCBzdHlsZSA9IHt9O1xyXG4gICAgbGV0IGJvcmRlclN0eWxlID0gYCR7YXJyb3dCb3JkZXJXaWR0aH1weCBzb2xpZCByZ2JhKDAsIDAsIDAsIDAuMylgO1xyXG4gICAgbGV0IHRhcmdldFBvc2l0aW9uID0gcG9zaXRpb24udGFyZ2V0LnNwbGl0KCctJyk7XHJcbiAgICBsZXQgY29udGVudFBvc2l0aW9uID0gcG9zaXRpb24uY29udGVudC5zcGxpdCgnLScpO1xyXG5cclxuICAgIGxldCBoYXNBcnJvdyA9IHRydWU7XHJcbiAgICBsZXQgbWFyZ2luID0gYCR7aGFsZkRpYWdvbmFsfXB4YFxyXG4gICAgaWYoaXNPbmVPZk5vQXJyb3cocG9zaXRpb24pKVxyXG4gICAgICAgIGhhc0Fycm93ID0gZmFsc2U7XHJcbiAgICBlbHNlIGlmKHRhcmdldFBvc2l0aW9uWzBdID09PSBhbGlnbm1lbnQuVE9QICYmIGNvbnRlbnRQb3NpdGlvblswXSA9PT0gYWxpZ25tZW50LkJPVFRPTSl7XHJcbiAgICAgICAgLy9kb3duXHJcbiAgICAgICAgc3R5bGVbYXJyb3dCb3JkZXIuQk9UVE9NXSA9IGJvcmRlclN0eWxlO1xyXG4gICAgICAgIHN0eWxlW2Fycm93Qm9yZGVyLlJJR0hUXSA9IGJvcmRlclN0eWxlO1xyXG5cclxuICAgICAgICBzdHlsZVthcnJvd0FsaWduLlRPUF0gPSBjb250ZW50RGltZW5zaW9ucy5oZWlnaHQrXCJweFwiO1xyXG4gICAgICAgIHN0eWxlW2Fycm93QWxpZ24uTEVGVF0gPSBjYWxjdWxhdGVBcnJvd1Bvc2l0aW9uKGNvbnRlbnRQb3NpdGlvblsxXSwgaG9yaXpvbnRhbEFsaWdubWVudCwgY29udGVudERpbWVuc2lvbnMud2lkdGgpO1xyXG4gICAgICAgIHN0eWxlWydtYXJnaW4tYm90dG9tJ10gPSBtYXJnaW47XHJcblxyXG4gICAgfSBlbHNlIGlmKHRhcmdldFBvc2l0aW9uWzFdID09PSBhbGlnbm1lbnQuU1RBUlQgJiYgY29udGVudFBvc2l0aW9uWzFdID09PSBhbGlnbm1lbnQuRU5EKXtcclxuICAgICAgICAvL3JpZ2h0XHJcbiAgICAgICAgc3R5bGVbYXJyb3dCb3JkZXIuUklHSFRdID0gYm9yZGVyU3R5bGU7XHJcbiAgICAgICAgc3R5bGVbYXJyb3dCb3JkZXIuVE9QXSA9IGJvcmRlclN0eWxlO1xyXG5cclxuICAgICAgICBzdHlsZVthcnJvd0FsaWduLlRPUF0gPSBjYWxjdWxhdGVBcnJvd1Bvc2l0aW9uKGNvbnRlbnRQb3NpdGlvblswXSwgdmVydGljYWxBbGlnbm1lbnQsIGNvbnRlbnREaW1lbnNpb25zLmhlaWdodCwgaGFsZkRpYWdvbmFsKTtcclxuICAgICAgICBzdHlsZVthcnJvd0FsaWduLkxFRlRdID0gYCR7Y29udGVudERpbWVuc2lvbnMud2lkdGggLSBoYWxmRGlhZ29uYWwgKyAyfXB4YDtcclxuXHJcbiAgICAgICAgc3R5bGVbJ21hcmdpbi1yaWdodCddID0gbWFyZ2luO1xyXG5cclxuICAgIH0gZWxzZSBpZih0YXJnZXRQb3NpdGlvblsxXSA9PT0gYWxpZ25tZW50LkVORCAmJiBjb250ZW50UG9zaXRpb25bMV0gPT09IGFsaWdubWVudC5TVEFSVCl7XHJcbiAgICAgICAgLy9sZWZ0XHJcbiAgICAgICAgc3R5bGVbYXJyb3dCb3JkZXIuTEVGVF0gPSBib3JkZXJTdHlsZTtcclxuICAgICAgICBzdHlsZVthcnJvd0JvcmRlci5CT1RUT01dID0gYm9yZGVyU3R5bGVcclxuXHJcbiAgICAgICAgc3R5bGVbYXJyb3dBbGlnbi5UT1BdID0gYCR7Y2FsY3VsYXRlQXJyb3dQb3NpdGlvbihjb250ZW50UG9zaXRpb25bMF0sIHZlcnRpY2FsQWxpZ25tZW50LCBjb250ZW50RGltZW5zaW9ucy5oZWlnaHQsIGhhbGZEaWFnb25hbCl9YDtcclxuICAgICAgICBzdHlsZVthcnJvd0FsaWduLkxFRlRdID0gYCR7LSBoYWxmRGlhZ29uYWwgKyAyfXB4YDtcclxuXHJcbiAgICAgICAgc3R5bGVbJ21hcmdpbi1sZWZ0J10gPSBtYXJnaW47XHJcblxyXG4gICAgfSAgZWxzZSBpZih0YXJnZXRQb3NpdGlvblswXSA9PT0gYWxpZ25tZW50LkJPVFRPTSAmJiBjb250ZW50UG9zaXRpb25bMF0gPT09IGFsaWdubWVudC5UT1Ape1xyXG4gICAgICAgIC8vdXBcclxuICAgICAgICBzdHlsZVthcnJvd0JvcmRlci5MRUZUXSA9IGJvcmRlclN0eWxlO1xyXG4gICAgICAgIHN0eWxlW2Fycm93Qm9yZGVyLlRPUF0gPSBib3JkZXJTdHlsZVxyXG5cclxuICAgICAgICBzdHlsZVthcnJvd0FsaWduLlRPUF0gPSAwO1xyXG4gICAgICAgIHN0eWxlW2Fycm93QWxpZ24uTEVGVF0gPSBjYWxjdWxhdGVBcnJvd1Bvc2l0aW9uKGNvbnRlbnRQb3NpdGlvblsxXSwgaG9yaXpvbnRhbEFsaWdubWVudCwgY29udGVudERpbWVuc2lvbnMud2lkdGgpO1xyXG5cclxuICAgICAgICBzdHlsZVsnbWFyZ2luLXRvcCddID0gbWFyZ2luO1xyXG4gICAgfSBlbHNlXHJcbiAgICAgICAgaGFzQXJyb3cgPSBmYWxzZTtcclxuXHJcbiAgICByZXR1cm4ge2hhc0Fycm93OiBoYXNBcnJvdywgc3R5bGU6IHN0eWxlfTtcclxufVxyXG5cclxuY29uc3QgZ2V0U3R5bGVCeVBvc2l0aW9uID0gKHBvc2l0aW9uLCB0YXJnZXREaW1lbnNpb25zLCBjb250ZW50RGltZW5zaW9ucywgd2luZG93V2lkdGgsIGhpZGVUYWlsKSA9PiB7XHJcbiAgICBsZXQgc3R5bGUgPSB7fTtcclxuICAgIGxldCB0YXJnZXRQb3NpdGlvbiA9IHBvc2l0aW9uLnRhcmdldC5zcGxpdCgnLScpO1xyXG4gICAgbGV0IGNvbnRlbnRQb3NpdGlvbiA9IHBvc2l0aW9uLmNvbnRlbnQuc3BsaXQoJy0nKTtcclxuXHJcbiAgICBpZih0YXJnZXRQb3NpdGlvbil7XHJcbiAgICAgICAgbGV0IHZlcnRpY2FsQWxpZ24gPSB0YXJnZXRQb3NpdGlvblswXTtcclxuICAgICAgICBsZXQgaG9yaXpvbnRhbEFsaWduID0gdGFyZ2V0UG9zaXRpb25bMV07XHJcblxyXG4gICAgICAgIGxldCB0YXJnZXRXaWR0aCA9IHRhcmdldERpbWVuc2lvbnMud2lkdGg7XHJcbiAgICAgICAgbGV0IHRhcmdldEhlaWdodCA9IHRhcmdldERpbWVuc2lvbnMuaGVpZ2h0O1xyXG5cclxuICAgICAgICBsZXQgYWRkUHggPSAwO1xyXG4gICAgICAgIGxldCBhZGRQeFkgPSAwXHJcbiAgICAgICAgbGV0IG5lZWRNb3ZlQ29udGVudCA9IHZlcnRpY2FsQWxpZ24gPT09IGFsaWdubWVudC5UT1AgJiYgY29udGVudFBvc2l0aW9uWzBdID09PSBhbGlnbm1lbnQuQk9UVE9NO1xyXG4gICAgICAgIGxldCBuZWVkTW92ZUNvbnRlbnRZID0gaG9yaXpvbnRhbEFsaWduID09PSBhbGlnbm1lbnQuU1RBUlQgJiYgY29udGVudFBvc2l0aW9uWzFdID09PSBhbGlnbm1lbnQuRU5EO1xyXG4gICAgICAgIGlmKG5lZWRNb3ZlQ29udGVudCAmJiAhaGlkZVRhaWwgJiYgIWlzT25lT2ZOb0Fycm93KHBvc2l0aW9uKSlcclxuICAgICAgICAgICAgYWRkUHggPSAtaGFsZkRpYWdvbmFsO1xyXG5cclxuICAgICAgICBpZihuZWVkTW92ZUNvbnRlbnRZICYmICFoaWRlVGFpbCAmJiAhaXNPbmVPZk5vQXJyb3cocG9zaXRpb24pKVxyXG4gICAgICAgICAgICBhZGRQeFkgPSAtaGFsZkRpYWdvbmFsO1xyXG5cclxuICAgICAgICBzdHlsZS50b3AgPSBjYWxjdWxhdGVQb3NpdGlvbih2ZXJ0aWNhbEFsaWduLCB2ZXJ0aWNhbEFsaWdubWVudCwgdGFyZ2V0SGVpZ2h0LCBhZGRQeCk7XHJcbiAgICAgICAgc3R5bGUubGVmdCA9IGNhbGN1bGF0ZVBvc2l0aW9uKGhvcml6b250YWxBbGlnbiwgaG9yaXpvbnRhbEFsaWdubWVudCwgdGFyZ2V0V2lkdGgsIGFkZFB4WSk7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIGxldCB4LCB5O1xyXG4gICAgaWYoY29udGVudFBvc2l0aW9uKXtcclxuICAgICAgICBsZXQgdmVydGljYWxBbGlnbiA9IGNvbnRlbnRQb3NpdGlvblswXTtcclxuICAgICAgICBsZXQgaG9yaXpvbnRhbEFsaWduID0gY29udGVudFBvc2l0aW9uWzFdO1xyXG5cclxuICAgICAgICBsZXQgY29udGVudFdpZHRoID0gY29udGVudERpbWVuc2lvbnMud2lkdGg7XHJcbiAgICAgICAgbGV0IGNvbnRlbnRIZWlnaHQgPSBjb250ZW50RGltZW5zaW9ucy5oZWlnaHQ7XHJcblxyXG4gICAgICAgIHkgPSBjYWxjdWxhdGVQb3NpdGlvbih2ZXJ0aWNhbEFsaWduLCB2ZXJ0aWNhbEFsaWdubWVudCwgLWNvbnRlbnRIZWlnaHQpO1xyXG4gICAgICAgIHggPSBjYWxjdWxhdGVQb3NpdGlvbihob3Jpem9udGFsQWxpZ24sIGhvcml6b250YWxBbGlnbm1lbnQsIC1jb250ZW50V2lkdGgpO1xyXG5cclxuICAgICAgICBzdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlM2QoJHt4fSwgJHt5fSwgMClgO1xyXG4gICAgfVxyXG5cclxuICAgIGxldCByZXN1bHRYID0gdGFyZ2V0RGltZW5zaW9ucy54ICtcclxuICAgICAgICBwYXJzZUludChzdHlsZS5sZWZ0LnJlcGxhY2UoXCJweFwiLCAnJykpICtcclxuICAgICAgICBwYXJzZUludCh4LnJlcGxhY2UoXCJweFwiLCAnJykpO1xyXG5cclxuICAgIGxldCByZXN1bHRZID0gdGFyZ2V0RGltZW5zaW9ucy55ICtcclxuICAgICAgICBwYXJzZUludChzdHlsZS50b3AucmVwbGFjZShcInB4XCIsICcnKSkgK1xyXG4gICAgICAgIHBhcnNlSW50KHkucmVwbGFjZShcInB4XCIsICcnKSk7XHJcblxyXG4gICAgbGV0IGlzWFZpc2libGUgPSByZXN1bHRYPjAgJiYgKHJlc3VsdFggKyBjb250ZW50RGltZW5zaW9ucy53aWR0aCkgPCB3aW5kb3dXaWR0aDtcclxuICAgIGxldCBpc1lWaXNpYmxlID0gcmVzdWx0WT4wO1xyXG5cclxuICAgIGxldCBpc1Zpc2libGUgPSBpc1hWaXNpYmxlICYmIGlzWVZpc2libGU7XHJcblxyXG4gICAgY29uc29sZS5sb2coXCJ2aXNpYmlsaXR5XCIsIGlzVmlzaWJsZSk7XHJcbiAgICByZXR1cm4ge3N0eWxlOiBzdHlsZSwgaXNWaXNpYmxlOiBpc1Zpc2libGV9O1xyXG59XHJcblxyXG5cclxuZXhwb3J0IGNvbnN0IGdldFBvcG92ZXJTdHlsZSA9IChwb3NpdGlvbnMsIHRhcmdldERpbWVuc2lvbnMsIGNvbnRlbnREaW1lbnNpb25zLCB3aW5kb3dXaWR0aCwgaGlkZVRhaWwpID0+IHtcclxuICAgIGxldCBzdHlsZSA9IHt9O1xyXG5cclxuICAgIGxldCByZXN1bHQ7XHJcbiAgICBsZXQgYXJyb3dTdHlsZXMgPSB7IGhhc0Fycm93OiBmYWxzZSwgc3R5bGU6e319O1xyXG4gICAgZm9yKGxldCBpID0gMDsgaTxwb3NpdGlvbnMubGVuZ3RoOyBpKyspe1xyXG4gICAgICAgIHJlc3VsdCA9IGdldFN0eWxlQnlQb3NpdGlvbihwb3NpdGlvbnNbaV0sIHRhcmdldERpbWVuc2lvbnMsIGNvbnRlbnREaW1lbnNpb25zLCB3aW5kb3dXaWR0aCwgaGlkZVRhaWwpO1xyXG4gICAgICAgIGlmKHJlc3VsdC5pc1Zpc2libGUpXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICBzdHlsZSA9IHJlc3VsdC5zdHlsZTtcclxuICAgICAgICAgICAgaWYoIWhpZGVUYWlsKVxyXG4gICAgICAgICAgICAgICAgYXJyb3dTdHlsZXMgPSBnZXRBcnJvd1N0eWxlcyAocG9zaXRpb25zW2ldLCBjb250ZW50RGltZW5zaW9ucyk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1lbHNlIGlmKGkgPT09IHBvc2l0aW9ucy5sZW5ndGggLTEpXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICBzdHlsZSA9IGdldFN0eWxlQnlQb3NpdGlvbihwb3NpdGlvbnNbMF0sIHRhcmdldERpbWVuc2lvbnMsIGNvbnRlbnREaW1lbnNpb25zLCB3aW5kb3dXaWR0aCwgaGlkZVRhaWwpLnN0eWxlO1xyXG4gICAgICAgICAgICBpZighaGlkZVRhaWwpXHJcbiAgICAgICAgICAgICAgICBhcnJvd1N0eWxlcyA9IGdldEFycm93U3R5bGVzIChwb3NpdGlvbnNbMF0sIGNvbnRlbnREaW1lbnNpb25zKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHJldHVybiB7c3R5bGU6IHN0eWxlLCBoYXNBcnJvdzogYXJyb3dTdHlsZXMuaGFzQXJyb3csIGFycm93U3R5bGU6IGFycm93U3R5bGVzLnN0eWxlfTtcclxufSJdfQ==